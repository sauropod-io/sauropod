name: Build Release

on:
  # Generate release artifacts when any tag is pushed
  push:
    tags:
      - "v*"

env:
  # We don't need incremental compilation in CI
  CARGO_INCREMENTAL: "0"
  CARGO_TERM_COLORS: always

jobs:
  generate-target-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate-target-matrix.outputs.matrix }}
      container-matrix: ${{ steps.generate-target-matrix.outputs.container-matrix }}
    steps:
      - id: generate-target-matrix
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            function matrixEntry(arch, os, image, march, variants = []) {
              let goarch;
              switch (arch) {
                case 'x86_64':
                  goarch = 'amd64';
                  break;
                case 'aarch64':
                  goarch = 'arm64';
                  break;
                default:
                  throw new Error(`Unsupported architecture: ${arch}`);
              }

              const entries = []
              const base = {
                arch,
                goarch,
                os,
                image,
                binary_suffix: `${os}-${arch}`,
                rustflags: '',
              };
              if (march) {
                base.rustflags = `-Ctarget-cpu=${march}`;
              }

              if (variants.length > 0) {
                for (const variant of variants) {
                  entries.push({
                    ...base,
                    binary_suffix: `${base.binary_suffix}-${variant}`,
                    variant,
                  });
                }
              } else {
                entries.push(base);
              }
              return entries
            }

            const matrix = [];

            const containerMatrix = matrixEntry('x86_64', 'linux', 'ubuntu-latest', 'skylake', ['cuda', 'vulkan']);

            if (context.repo.repo == 'sauropod' && context.repo.owner == 'sauropod-io') {
              containerMatrix.push(...matrixEntry('aarch64', 'linux', 'ubuntu-24.04-arm', "cortex-a76", ['cuda', 'vulkan']))
              matrix.push(...matrixEntry('aarch64', 'macos', 'macos-latest', null));
            }

            core.setOutput('matrix', JSON.stringify(matrix));
            console.log("Matrix:", JSON.stringify(matrix, null, 2));
            core.setOutput('container-matrix', JSON.stringify(containerMatrix));
            console.log("Container Matrix:", JSON.stringify(containerMatrix, null, 2));
  build-release-binaries:
    needs: [generate-target-matrix]
    strategy:
      matrix:
        include: ${{ fromJson(needs.generate-target-matrix.outputs.matrix) }}
    if: github.repository == 'sauropod-io/sauropod'
    permissions:
      id-token: write
      contents: read
      attestations: write
    runs-on: ${{ matrix.image }}
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - name: Set up
        uses: ./.github/actions/set-up-rust
      - name: Install vulkan-tools
        if: runner.os == 'Linux'
        run: sudo apt-get install -y vulkan-tools glslc libvulkan-dev

      - name: Build the release
        run: |
          make release CARGO_FEATURES="${{ matrix.variant }}"
          mkdir sauropod-inference-server-${{ matrix.binary_suffix }}
          mv target/optimized-release/sauropod-inference-server sauropod-inference-server-${{ matrix.binary_suffix }}/
          mv target/optimized-release/libonnx* sauropod-inference-server-${{ matrix.binary_suffix }}/
          tar -czf sauropod-inference-server-${{ matrix.binary_suffix }}.tar.gz sauropod-inference-server-${{ matrix.binary_suffix }}
        env:
          SCCACHE_GHA_ENABLED: "true"
          RUSTC_WRAPPER: "sccache"
          SOURCE_DATE_EPOCH: 0

      - name: Upload artifacts
        id: upload
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: sauropod-inference-server-${{ matrix.binary_suffix }}.tar.gz
          path: |
            sauropod-inference-server-${{ matrix.binary_suffix }}.tar.gz
      - uses: actions/attest-build-provenance@e8998f949152b193b063cb0ec769d69d929409be # v2
        with:
          subject-name: sauropod-inference-server-${{ matrix.binary_suffix }}.tar.gz
          subject-digest: sha256:${{ steps.upload.outputs.artifact-digest }}
        if: github.repository == 'sauropod-io/sauropod'

  build-container:
    timeout-minutes: 120
    needs: [generate-target-matrix]
    strategy:
      matrix:
        include: ${{ fromJson(needs.generate-target-matrix.outputs.container-matrix) }}
    permissions:
      packages: write
      contents: read
    runs-on: ${{ matrix.image }}
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - name: Set up Docker
        uses: ./.github/actions/set-up-docker
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Docker metadata
        id: docker-metadata
        uses: docker/metadata-action@c1e51972afc2121e065aed6d45c65596fe445f3f # v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          labels: |
            org.opencontainers.image.licenses=AGPL-3.0-or-later
          flavor: |
            latest=false
            suffix=-${{ matrix.variant }}
      - name: Build and push image
        id: build
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          file: docker/Dockerfile.${{ matrix.variant }}
          push: false
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          platforms: ${{ matrix.os }}/${{ matrix.goarch }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: ${{ steps.docker-metadata.outputs.labels }}
          secret-envs: |
            actions_results_url=ACTIONS_RESULTS_URL
            actions_runtime_token=ACTIONS_RUNTIME_TOKEN
          outputs: type=image,push-by-digest=true,name-canonical=true,push=true
          build-args: |
            RUSTFLAGS=${{ matrix.rustflags }}

      - name: Export digest
        run: |
          mkdir -p ${{ runner.temp }}/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "${{ runner.temp }}/digests/${digest#sha256:}"
      - name: Upload digest
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: digests-${{ matrix.variant }}-${{ matrix.os }}-${{ matrix.goarch }}
          path: ${{ runner.temp }}/digests/*
          if-no-files-found: error
          retention-days: 1

  create-release:
    runs-on: ubuntu-latest
    needs: [build-release-binaries, build-container]
    permissions:
      contents: write
      id-token: write
      packages: write
      attestations: write
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - name: Set up Docker
        uses: ./.github/actions/set-up-docker
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Download Vulkan container digests
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          path: ${{ runner.temp }}/digests-vulkan
          pattern: digests-vulkan-*
          merge-multiple: true
      - name: Download CUDA container digests
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          path: ${{ runner.temp }}/digests-cuda
          pattern: digests-cuda-*
          merge-multiple: true
      - name: Docker Vulkan metadata
        id: docker-metadata-vulkan
        uses: docker/metadata-action@c1e51972afc2121e065aed6d45c65596fe445f3f # v5
        with:
          flavor: |
            latest=false
            suffix=-vulkan
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
      - name: Create Vulkan container manifest list and push
        working-directory: ${{ runner.temp }}/digests-vulkan
        run: |
          docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@sha256:%s ' *)
      - name: Docker CUDA metadata
        id: docker-metadata-cuda
        uses: docker/metadata-action@c1e51972afc2121e065aed6d45c65596fe445f3f # v5
        with:
          flavor: |
            latest=false
            suffix=-cuda
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
      - name: Create CUDA container manifest list and push
        working-directory: ${{ runner.temp }}/digests-cuda
        run: |
          docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@sha256:%s ' *)
      - name: Get final merged image digests
        run: |
          echo "IMAGE_DIGEST_VULKAN=$(docker buildx imagetools inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.docker-metadata-vulkan.outputs.version  }} --format '{{ json .Manifest.Digest }}' | jq -r)" >> $GITHUB_ENV
          echo "IMAGE_DIGEST_CUDA=$(docker buildx imagetools inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.docker-metadata-cuda.outputs.version  }} --format '{{ json .Manifest.Digest }}' | jq -r)" >> $GITHUB_ENV
      - name: Attestation for Vulkan Docker image
        uses: actions/attest-build-provenance@e8998f949152b193b063cb0ec769d69d929409be # v2
        id: attest-vulkan
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          subject-digest: ${{ env.IMAGE_DIGEST_VULKAN }}
          push-to-registry: true
        if: github.repository == 'sauropod-io/sauropod'
      - name: Attestation for CUDA Docker image
        uses: actions/attest-build-provenance@e8998f949152b193b063cb0ec769d69d929409be # v2
        id: attest-cuda
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          subject-digest: ${{ env.IMAGE_DIGEST_CUDA }}
          push-to-registry: true
        if: github.repository == 'sauropod-io/sauropod'
      - name: Download X86 artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          path: binaries
          # We don't use `sauropod-inference-server-*` here because it will capture Docker artifacts
          pattern: |
            sauropod-inference-server-*-x86_64*
          merge-multiple: true
      - name: Download Aarch64 artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          path: binaries
          pattern: sauropod-inference-server-*-aarch64*
          merge-multiple: true
        if: github.repository == 'sauropod-io/sauropod'
      - name: Create release
        id: create_release
        uses: softprops/action-gh-release@6cbd405e2c4e67a21c47fa9e383d020e4e28b836 # v2
        with:
          fail_on_unmatched_files: true
          files: binaries/*
          draft: true
